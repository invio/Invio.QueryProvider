image: Visual Studio 2017
version: '{build}'
pull_requests:
  do_not_increment_build_number: true
branches:
  except:
    - /wip-.*/
nuget:
  disable_publish_on_pr: true
services:
  - mysql
environment:
  mysql_password: 'Password12!'
  CODECOV_TOKEN:
    secure: /CUdMsHvn37uHup5duyGkVBpdVe/1FNO9/t/s1rM+4pRSly4WNbwPcOs6Lq0KqhG
before_build:
  - ps: if (-not (Test-Path .\artifacts)) { mkdir artifacts }
  - git submodule update --init --recursive -q
  - choco install opencover.portable
  - choco install codecov
build_script:
  - ps: '$InformationPreference = [System.Management.Automation.ActionPreference]::Continue; ./build.ps1'
before_test:
  - ps: .\Invio.QueryProvider.MySql\test\Invio.QueryProvider.MySql.Test\configure.ps1
test_script:
  - OpenCover.Console.exe -register:user -target:xunit.console.x86.exe "-targetargs:.\Invio.QueryProvider.Core\test\Invio.QueryProvider.Test\bin\Debug\netcoreapp2.0\Invio.QueryProvider.Test.dll" -output:".\Invio.QueryProvider-CodeCov.xml"
  - OpenCover.Console.exe -register:user -target:xunit.console.x86.exe "-targetargs:.\Invio.QueryProvider.Core\test\Invio.QueryProvider.Test.CSharp\bin\Debug\netcoreapp2.1\Invio.QueryProvider.Test.CSharp.dll" -output:".\Invio.QueryProvider-CodeCov.xml"
  - OpenCover.Console.exe -register:user -target:xunit.console.x86.exe "-targetargs:.\Invio.QueryProvider.MySql\test\Invio.QueryProvider.MySql.Test\bin\Debug\netcoreapp2.1\Invio.QueryProvider.MySql.Test.dll -noshadow" -output:".\Invio.QueryProvider-CodeCov.xml"
  - codecov -f ".\Invio.QueryProvider-CodeCov.xml"
artifacts:
  - path: .\artifacts\**\*.nupkg
    name: NuGet
  - path: .\Invio.QueryProvider-CodeCov.xml
    name: Coverage
deploy:
  - provider: NuGet
    name: production
    api_key:
      secure: ptJ1xOgh7IPWlk1romGqz589DLYuuVWeJdixYtc1CgpN3ZUmQY1PMjSXrVYpY/uW
    on:
      branch: master
      appveyor_repo_tag: true
